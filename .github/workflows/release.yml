name: Release Build

on:
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Build Script
        env:
          CI: true
        run: .\build.bat

      - name: Prepare Artifact
        shell: pwsh
        run: |
          $repoName = "${{ github.event.repository.name }}"
          $tagName = "${{ github.ref_name }}"
          $zipName = "${{ github.event.repository.name }}_${{ github.ref_name }}_win_x64.zip"

          echo "Zip Name: $zipName"

          # Check if build.bat already produced a zip (logic assumption based on user request, though build.bat currently only outputs a folder)
          # The current build.bat outputs to 'dist' folder. It does NOT zip.
          # So we must zip the content of 'dist'.

          # User logic:
          # "If build.bat already generated a ZIP, rename it."
          # "If ZIP is missing (only EXE), zip EXE+images+config+README."

          # Let's check 'dist' content.
          $distPath = "dist"
          $zipFiles = Get-ChildItem -Path $distPath -Filter *.zip

          if ($zipFiles.Count -gt 0) {
              echo "Found existing ZIP. Renaming..."
              $existingZip = $zipFiles[0].FullName
              Rename-Item -Path $existingZip -NewName $zipName
              Move-Item -Path "$distPath\$zipName" -Destination .
          } else {
              echo "No ZIP found. Creating new ZIP from dist folder..."
              # Items to zip: EXE, images, config, README
              # build.bat puts them all in dist/
              
              Compress-Archive -Path "$distPath\*" -DestinationPath $zipName
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ github.event.repository.name }}_${{ github.ref_name }}_win_x64.zip
