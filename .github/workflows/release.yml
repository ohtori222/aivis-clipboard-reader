name: Release Build

on:
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œãƒœã‚¿ãƒ³ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ã«è¿½åŠ ï¼‰
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write # Releaseã‚’ä½œæˆã™ã‚‹ãŸã‚ã«æ›¸ãè¾¼ã¿æ¨©é™ã‚’æ˜ç¤º

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: Run Build Script
        env:
          CI: true
        run: .\build.bat

      - name: Prepare Artifact
        shell: pwsh
        run: |
          $repoName = "${{ github.event.repository.name }}"
          $tagName = "${{ github.ref_name }}"
          # ã‚¿ã‚°åãŒå–ã‚Œãªã„å ´åˆï¼ˆæ‰‹å‹•å®Ÿè¡Œæ™‚ãªã©ï¼‰ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
          if ([string]::IsNullOrEmpty($tagName)) { $tagName = "manual-build" }

          $zipName = "${repoName}_${tagName}_win_x64.zip"

          echo "Zip Name: $zipName"

          # distãƒ•ã‚©ãƒ«ãƒ€ã®ä¸­èº«ã‚’ç¢ºèª
          $distPath = "dist"

          # build.batãŒZIPã‚’ä½œã£ã¦ã„ã‚‹ã‹ç¢ºèª
          if (Test-Path $distPath) {
              $zipFiles = Get-ChildItem -Path $distPath -Filter *.zip

              if ($zipFiles.Count -gt 0) {
                  echo "Found existing ZIP. Renaming..."
                  $existingZip = $zipFiles[0].FullName
                  Rename-Item -Path $existingZip -NewName $zipName
                  Move-Item -Path "$distPath\$zipName" -Destination .
              } else {
                  echo "No ZIP found. Creating new ZIP from dist folder..."
                  Compress-Archive -Path "$distPath\*" -DestinationPath $zipName
              }
          } else {
              Write-Error "dist folder not found! Build failed?"
          }

      - name: Generate Release Body
        shell: pwsh
        run: |
          $tagName = "${{ github.ref_name }}"
          $repo = "${{ github.repository }}"
          $artifactName = "${{ github.event.repository.name }}_${tagName}_win_x64.zip"

          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ç”Ÿæˆ
          $body = @"
          # ğŸ“¥ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          **[ğŸ‘‰ Windowsç‰ˆã‚¢ãƒ—ãƒªã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ ($artifactName)](https://github.com/$repo/releases/download/$tagName/$artifactName)**

          EXEç‰ˆã¯Pythonç’°å¢ƒãŒãªãã¦ã‚‚å‹•ãã¾ã™ã€‚
          "@

          $body | Out-File -FilePath release_header.md -Encoding utf8

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*_win_x64.zip"
          body_path: release_header.md
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
