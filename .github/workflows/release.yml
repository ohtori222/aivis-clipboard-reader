name: Release Build

on:
  workflow_dispatch: # 手動実行ボタン（デバッグ用に追加）
  push:
    tags:
      - "v*"

jobs:
  build-and-release:
    runs-on: windows-latest

    permissions:
      contents: write # Releaseを作成するために書き込み権限を明示

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"
          architecture: "x64"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if (Test-Path requirements.txt) { pip install -r requirements.txt }

      - name: Run Build Script
        env:
          CI: true
        run: .\build.bat

      - name: Prepare Artifact
        shell: pwsh
        run: |
          $repoName = "${{ github.event.repository.name }}"
          $tagName = "${{ github.ref_name }}"
          # タグ名が取れない場合（手動実行時など）のフォールバック
          if ([string]::IsNullOrEmpty($tagName)) { $tagName = "manual-build" }

          $zipName = "${repoName}_${tagName}_win_x64.zip"

          echo "Zip Name: $zipName"

          # distフォルダの中身を確認
          $distPath = "dist"

          # build.batがZIPを作っているか確認
          if (Test-Path $distPath) {
              $zipFiles = Get-ChildItem -Path $distPath -Filter *.zip
              
              if ($zipFiles.Count -gt 0) {
                  echo "Found existing ZIP. Renaming..."
                  $existingZip = $zipFiles[0].FullName
                  Rename-Item -Path $existingZip -NewName $zipName
                  Move-Item -Path "$distPath\$zipName" -Destination .
              } else {
                  echo "No ZIP found. Creating new ZIP from dist folder..."
                  Compress-Archive -Path "$distPath\*" -DestinationPath $zipName
              }
          } else {
              Write-Error "dist folder not found! Build failed?"
          }

      - name: Create Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: "*_win_x64.zip"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
