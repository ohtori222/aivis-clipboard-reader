name: Run Tests

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install --upgrade setuptools
          pip install -r requirements.txt
          pip install pytest pytest-mock pytest-cov
          pip install black isort flake8 mypy types-requests types-setuptools

      - name: Encure Code Quality (Lint & Format Check)
        run: |
          echo "Checking import sort order..."
          isort . --check --diff
          echo "Checking code formatting..."
          black . --check --diff
          echo "Checking static analysis..."
          flake8 .
          echo "Checking type safety..."
          mypy .

      - name: Security Check
        run: pip-audit

      - name: Run Tests with Coverage
        run: |
          pytest -v --cov=src --cov-report=term-missing

      - name: Verify Build Script (Dry Run)
        # 実際に exe を作れるか確認（ビルドエラーがないかチェック）
        run: |
          cmd /c build.bat
