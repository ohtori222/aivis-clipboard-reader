name: Run Tests

on:
  push:
    branches: ["master", "main"]
  pull_request:
    branches: ["master", "main"]

jobs:
  test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          architecture: "x64"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-mock
          pip install black isort flake8

      - name: Encure Code Quality (Lint & Format Check)
        run: |
          echo "Checking import sort order..."
          isort . --check --diff
          echo "Checking code formatting..."
          black . --check --diff
          echo "Checking static analysis..."
          flake8 .

      - name: Security Check
        run: pip-audit

      - name: Run Tests
        run: |
          pytest -v

      - name: Verify Build Script (Dry Run)
        # 実際に exe を作れるか確認（ビルドエラーがないかチェック）
        run: |
          cmd /c build.bat
